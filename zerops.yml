zerops:
  - setup: airflow-production-base
    build:
      deployFiles:
        - wait-mount.sh
    run:
      os: ubuntu
      base: python@3.12
      envVariables:
        SHARED_DAGS_FOLDER: /mnt/files/dags
        AIRFLOW_HOME: /var/www/airflow
        AIRFLOW__CORE__LOAD_EXAMPLES: "False"
        AIRFLOW__CORE__EXECUTOR: CeleryExecutor
        AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${db_user}:${db_password}@db/db
        AIRFLOW__CELERY__BROKER_URL: redis://redis:6379/0
        AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://${db_user}:${db_password}@db/db
      prepareCommands:
        - |
          cd /var/www
          uv venv
          source .venv/bin/activate
          python --version
          uv pip install --upgrade pip
          uv pip install "apache-airflow[celery,postgres,redis]==2.10.5" --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.10.5/constraints-3.12.txt"
        - mkdir -p $AIRFLOW_HOME
        - ln -s $SHARED_DAGS_FOLDER $AIRFLOW_HOME/dags
        # FIXME(tikinang): Remove after permissions of shared storage and prepare commands are fixed.
        - chown zerops:zerops -R $AIRFLOW_HOME
      initCommands:
        - ./wait-mount.sh

  - setup: airflowdags
    extends: airflow-production-base
    build:
      deployFiles:
        - wait-mount.sh
        - dags
    run:
      initCommands:
        - |
          source .venv/bin/activate
          zsc execOnce migrate -- airflow db migrate
          zsc execOnce create-user -- airflow users create --username admin --firstname Data --lastname Enjoyer --role Admin --email dev@zerops.io --password ${ADMIN_PASSWORD}
        - ./wait-mount.sh
        # FIXME(tikinang): Remove sudo after permissions of shared storage and prepare commands are fixed.
        - sudo mkdir -p $SHARED_DAGS_FOLDER
        # FIXME(tikinang): Remove command after permissions of shared storage and prepare commands are fixed.
        - sudo chown zerops:zerops -R $SHARED_DAGS_FOLDER
        - rsync -avzh ./dags/ $SHARED_DAGS_FOLDER
      start: zsc noop --silent

  - setup: airflowui
    extends: airflow-production-base
    run:
      ports:
        - port: 8080
          httpSupport: true
      start: |
        source .venv/bin/activate
        airflow webserver

  - setup: airflowscheduler
    extends: airflow-production-base
    run:
      start: |
        source .venv/bin/activate
        airflow scheduler

  - setup: airflowworkers
    extends: airflow-production-base
    run:
      start: |
        source .venv/bin/activate
        airflow celery worker

  # STANDALONE
  - setup: airflowstandalone
    build:
      deployFiles:
        - dags
    run:
      os: ubuntu
      base: python@3.12
      envVariables:
        AIRFLOW_HOME: /var/www/airflow
        AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      prepareCommands:
        - |
          cd /var/www
          uv venv
          source .venv/bin/activate
          python --version
          uv pip install --upgrade pip
          uv pip install "apache-airflow==2.10.5" --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.10.5/constraints-3.12.txt"
      ports:
        - port: 8080
          httpSupport: true
      start: |
        source .venv/bin/activate
        airflow standalone